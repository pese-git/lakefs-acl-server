
# **Фаза 1 — ACL сервер для lakeFS 1.73 OSS (с базовой защитой API)**

Цель: создать минимально жизнеспособный ACL‑сервер, полностью совместимый с lakeFS 1.73, поддерживающий CRUD для пользователей, групп, политик и креденшлов, при этом **API защищено простым токеном**.

---

## Итерация 1.1 — Подготовка проекта и инфраструктуры (1–2 дня)

**Задачи:**

* Создать репозиторий проекта.
* Настроить виртуальное окружение / Docker.
* Добавить зависимости: FastAPI, SQLAlchemy, Alembic, Pydantic, psycopg2.
* Настроить подключение к Postgres.
* Создать базовую структуру проекта:

```
acl_server/
  app/
    main.py
    api/
    models.py
    schemas.py
    db.py
    auth.py
```

* Добавить endpoint `/health` для проверки статуса сервера.

**Выходной продукт:**
Рабочий skeleton проекта, FastAPI стартует и подключается к Postgres.

---

## Итерация 1.2 — Базовая защита API (1–2 дня)

**Задачи:**

* Ввести простой токен/секрет для защиты API (`API_SECRET` или `auth.api_token` в конфиге).
* Реализовать проверку токена для всех endpoint’ов (через FastAPI `Depends`).
* Любой запрос без правильного токена возвращает `401 Unauthorized`.
* Хранить токен в конфигурации или ENV-переменной, не в коде.

**Выходной продукт:**
Все запросы к ACL API требуют токен. lakeFS использует токен в `auth.api.token`.

---

## Итерация 1.3 — Модели данных и миграции (2–3 дня)

**Задачи:**

* Создать модели SQLAlchemy:

  * User, Group, Policy, Credential.
  * Связи: User ↔ Group, User/Group ↔ Policy.
* Настроить Alembic для миграций.
* Провести первую миграцию — создать таблицы в БД.

**Выходной продукт:**
SQLite содержит все таблицы, можно создавать записи через SQL.

---

## Итерация 1.4 — CRUD Users API (2–3 дня)

* Endpoint’ы: `POST /auth/users`, `GET /auth/users`, `GET /auth/users/{user_id}`, `DELETE /auth/users/{user_id}`
* Все endpoint’ы защищены токеном (`Depends(verify_token)`).
* Тесты CRUD пользователей.

**Выходной продукт:**
Рабочий CRUD пользователей с базовой защитой API.

---

## Итерация 1.5 — CRUD Groups API (2–3 дня)

* Endpoint’ы: `POST /auth/groups`, `GET /auth/groups`, `GET /auth/groups/{group_id}`, `DELETE /auth/groups/{group_id}`
* Привязка пользователей к группам:

  * `PUT /auth/groups/{group_id}/members/{user_id}`
  * `DELETE /auth/groups/{group_id}/members/{user_id}`
  * `GET /auth/groups/{group_id}/members`
* Все endpoint’ы защищены токеном.

**Выходной продукт:**
Рабочий CRUD групп + управление членством, защищенный токеном.

---

## Итерация 1.6 — CRUD Policies API (2–3 дня)

* Endpoint’ы: `POST /auth/policies`, `GET /auth/policies`, `GET /auth/policies/{policy_id}`, `PUT /auth/policies/{policy_id}`, `DELETE /auth/policies/{policy_id}`
* Назначение политик пользователям/группам через `PUT`/`DELETE` endpoints.
* Все endpoint’ы защищены токеном.

**Выходной продукт:**
Рабочий CRUD политик + привязка к пользователям и группам, защищённый токеном.

---

## Итерация 1.7 — CRUD Credentials API (2–3 дня)

* Endpoint’ы:

  * `POST /auth/users/{user_id}/credentials`
  * `GET /auth/users/{user_id}/credentials`
  * `GET /auth/users/{user_id}/credentials/{access_key_id}`
  * `DELETE /auth/users/{user_id}/credentials/{access_key_id}`
  * `GET /auth/credentials/{access_key_id}` для lakeFS
* Генерация access_key/secret_key.
* Все endpoint’ы защищены токеном.

**Выходной продукт:**
Рабочий credentials API, lakeFS может использовать credentials, все запросы проверяют токен.

---

## Итерация 1.8 — Интеграция с lakeFS и тестирование (3–4 дня)

* Настроить lakeFS 1.73 OSS:

  * `auth.ui_config.rbac = "simplified"`
  * `auth.api.endpoint = <URL вашего ACL>`
  * `auth.api.token = <API_SECRET>`
* Проверка полного цикла:

  * Создание пользователей → креденшлы → аутентификация lakeFS.
  * Проверка назначения политик и прав.
* Написать интеграционные тесты.
* Добавить HTTPS (опционально на первом этапе) и логирование базового аудита.

**Выходной продукт:**
Рабочий ACL‑сервер с базовой защитой API, полностью совместимый с lakeFS 1.73 OSS.

---

# **Фаза 2 — Внешняя аутентификация (OIDC/SSO)**

**Цель:** добавить возможность внешней аутентификации через OIDC/SSO, при этом ACL‑сервер продолжает взаимодействовать с lakeFS через API с токеном. Пользователи могут логиниться через IdP, а ACL‑сервер выдаёт им credentials для lakeFS и управляет правами через политики.

---

## Итерация 2.1 — Подготовка и настройка OIDC (1–2 дня)

**Задачи:**

* Выбрать OIDC-провайдера для теста (Keycloak, Auth0, Okta и т.п.).
* Настроить тестовый клиент OIDC:

  * client_id
  * client_secret
  * redirect_uri (куда IdP будет отправлять callback)
* Добавить библиотеку Python для OIDC: `authlib` или аналог.
* Настроить конфигурацию ACL‑сервера для OIDC:

```yaml
oidc:
  client_id: "<OIDC_CLIENT_ID>"
  client_secret: "<OIDC_CLIENT_SECRET>"
  issuer_url: "<OIDC_ISSUER_URL>"
  redirect_uri: "https://<acl-server>/auth/callback"
```

**Выходной продукт:**
ACL‑сервер готов подключаться к OIDC-провайдеру, можно получать тестовые токены.

---

## Итерация 2.2 — Аутентификация пользователей через OIDC (2–3 дня)

**Задачи:**

* Реализовать endpoint `/auth/login`:

  * Перенаправляет пользователя на IdP для аутентификации.
* Endpoint `/auth/callback`:

  * Получает `id_token` и `access_token` от IdP.
  * Верифицирует подпись и срок действия токена.
* Извлечение claim’ов из id_token:

  * user_id / sub
  * email
  * groups / roles (по возможности)
* Создание или обновление внутреннего пользователя в базе ACL‑сервера:

  * Если пользователь новый → создаётся запись в `User`.
  * Если пользователь существует → обновляются данные.

**Выходной продукт:**
Пользователи могут логиниться через OIDC, в ACL‑сервере создаются соответствующие внутренние пользователи.

---

## Итерация 2.3 — Генерация credentials для lakeFS (2–3 дня)

**Задачи:**

* После успешного OIDC‑логина ACL‑сервер генерирует или ищет существующие credentials (access_key_id + secret_access_key) для пользователя.
* Эти credentials будут использоваться lakeFS для аутентификации через `GET /auth/credentials/{access_key_id}`.
* Можно хранить mapping между OIDC-sub → User → Credentials.

**Выходной продукт:**
Каждому OIDC-пользователю соответствует уникальные credentials для lakeFS.

---

## Итерация 2.4 — Назначение политик на основе OIDC claims (2–3 дня)

**Задачи:**

* Настроить маппинг OIDC-groups / roles → политики ACL:

  * Например: `oidc_group:devs` → ACL policy: `read-write` на определённые репозитории.
* При первом логине пользователя ACL‑сервер автоматически назначает политики в базе.
* При последующих логинах → проверяет соответствие claim’ов с существующими назначениями политик.
* endpoint lakeFS по-прежнему работает через токен (базовая защита API остаётся), credentials используются для операций.

**Выходной продукт:**
Пользователи OIDC автоматически получают права и credentials для lakeFS на основе своих claim’ов.

---

## Итерация 2.5 — UI / CLI поддержка OIDC (2–3 дня)

**Задачи:**

* Настроить возможность логина через браузер (UI) и/или перенаправление через CLI:

  * CLI может открыть ссылку login → callback.
* Проверка, что после логина пользователь получает корректные credentials.
* Логику можно скрыть внутри ACL‑серверного API: lakeFS всегда использует `GET /auth/credentials/{access_key_id}`.

**Выходной продукт:**
Пользователь может авторизоваться через OIDC, credentials выдаются автоматически, lakeFS полностью интегрирован.

---

## Итерация 2.6 — Интеграция с lakeFS и тестирование (3–4 дня)

**Задачи:**

* Проверка полного цикла:

  * Пользователь логинится через OIDC.
  * ACL‑сервер создаёт или обновляет пользователя и credentials.
  * lakeFS использует credentials для операций.
  * Проверка применения политик на реальные репозитории / ветки.
* Написать unit + интеграционные тесты:

  * Вход через OIDC.
  * Генерация credentials.
  * Назначение политик.
  * Проверка прав в lakeFS.
* Добавить логирование событий OIDC-логина и выдачи credentials.
* Проверить защиту API через базовый токен (не нарушена).

**Выходной продукт:**
Полностью рабочий ACL‑сервер с OIDC/SSO, интеграцией с lakeFS и базовой защитой API.

---

## Итерация 2.7 — Документация и инструкции (1–2 дня)

**Задачи:**

* Документировать процесс настройки OIDC для ACL‑сервера.
* Прописать инструкции для lakeFS:

  * `auth.api.endpoint`
  * `auth.api.token`
  * Как использовать credentials после логина OIDC.
* Добавить описание политики маппинга OIDC-groups → ACL policies.
* Описание резервного восстановления / бэкапа базы ACL.

**Выходной продукт:**
Полная документация для администраторов и пользователей.

---

### ✅ Итог Фазы 2

* ACL‑сервер поддерживает **внешнюю аутентификацию через OIDC/SSO**.
* Пользователи автоматически создаются в базе и получают credentials для lakeFS.
* Назначение политик основано на OIDC claim’ах.
* Базовая защита API (токен) остаётся активной для всех CRUD endpoint’ов.
* LakeFS 1.73 OSS полностью интегрирован, аутентификация и авторизация через ACL‑сервер работают корректно.

